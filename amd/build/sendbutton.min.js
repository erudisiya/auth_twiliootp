define(['jquery', 'core/ajax'],
	function ($, ajax) {
		return {
            auth_twiliootp: function (pluginname,minrequestperiod){
            	console.log(pluginname);
            	$("#id_submitbutton,#id_phone2").prop('disabled', true);
            	$('#otpButton,#otpbox,#verifybutton,.verfied-otp-container,.notverfied-otp-container,.otpsent_message,.otpnotsent_message,.invalid_number,.already_phone,.already_username,.already_email').hide();
            	$('#id_country').change(function() {
            		if($(this).val() != ""){
            			$("#id_phone2").prop('disabled', false);
            			//countrycode.handleCountrySelection();
            			//console.log('show');
            		} else {
            			$("#id_phone2").prop('disabled', true);
            		}
            	});
            	$('#id_phone2').on('input', function(event) {
		            var phoneNumber = $(this).val().trim();
		            if (/^\d+$/.test(phoneNumber)) {
		            	//$('.qheader').append('<button id="myButton">Click me</button>');
		                $('#otpButton').show();// Show Send OTP button
		            } else {
		                $('#otpButton').hide(); // Hide Send OTP button
		            }
		            
		        });
            	// Restrict OTP input to 4 digits and numeric only
	            $('#otpbox').on('input', function(event) {
	                var otp = $(this).val().trim();
	                // Remove non-numeric characters from input
	                var numericOtp = otp.replace(/\D/g, '');
	                // Limit input to first 4 characters
	                var trimmedOtp = numericOtp.slice(0, 4);
	                // Update input value with cleaned and trimmed OTP
	                $(this).val(trimmedOtp);
	            });
            	var otpBtn = $('#otpButton');
            	if (otpBtn) {
            		otpBtn.click(function (event) {
            			event.preventDefault();
            			$('.otpsent_message,.otpnotsent_message,.invalid_number,.notverfied-otp-container,.already_username,.already_email,.already_phone').hide();
            			$('#loader-container').fadeIn();
            			setTimeout(function() {
            				$('#loader-container').fadeOut(function() {
            					usermobile = $('#id_phone2').val();
		            			username = $('#id_username').val();
		            			useremail = $('#id_email').val();
		            			usercountry = $('#id_country').val();
		            			var promises = ajax.call([{
		                            methodname: 'moodle_twiliootp_twiliootp_js_settings',
		                            args: {flag:1,phone:usermobile,username:username,useremail:useremail,usercountry:usercountry},
		                        }]);
		                        promises[0].then(function (data) {
									console.log(data);
									if(data['status'] == 1){
										$('.otpsent_message').show();
								        $('#mobile-number').text(usermobile);
								        $('#success-message').fadeIn();
								        
								        var countdown = minrequestperiod / 100; // Countdown from 6 seconds
								        $('#otpButton').text('Resend OTP (' + countdown + 's)').prop('disabled', true);
								        
								        var interval = setInterval(function () {
								            countdown--;
								            if (countdown >= 0) {
								                $('#otpButton').text('Resend OTP (' + countdown + 's)');
								            } else {
								                clearInterval(interval);
								                $('#otpButton').text('Resend OTP').prop('disabled', false);
								            }
								        }, 1000); // Update countdown every second (1000 milliseconds)
								        
								        // Show additional elements if needed
								        $('#otpbox, #verifybutton').show();
								        $('#id_username,#id_email,#id_phone2').prop('disabled', false);
									} else if(data['status'] == 2){
										$('.otpnotsent_message').show();
							            $('#otpbox, #verifybutton').hide();
									} else if(data['status'] == 3) {
										$('.invalid_number').show();
							            $('#otpbox, #verifybutton').hide();
									} else if(data['status'] == 4) {
										$('.already_username').show();
									} else if(data['status'] == 5) {
										$('.already_email').show();
									} else if(data['status'] == 6) {
										$('.already_phone').show();
									}
		                        	// Split error_code into an array
								    /*let errorCodes = options['error_code'] ? options['error_code'].split(',') : [];
								    if (errorCodes.includes('0')) {
								    	console.log('jache');
							            $('.otpsent_message').show();
								        $('#mobile-number').text(usermobile);
								        $('#success-message').fadeIn();
								        
								        var countdown = minrequestperiod / 100; // Countdown from 6 seconds
								        $('#otpButton').text('Resend OTP (' + countdown + 's)').prop('disabled', true);
								        
								        var interval = setInterval(function () {
								            countdown--;
								            if (countdown >= 0) {
								                $('#otpButton').text('Resend OTP (' + countdown + 's)');
								            } else {
								                clearInterval(interval);
								                $('#otpButton').text('Resend OTP').prop('disabled', false);
								            }
								        }, 1000); // Update countdown every second (1000 milliseconds)
								        
								        // Show additional elements if needed
								        $('#otpbox, #verifybutton').show();
								        $('#id_username,#id_email,#id_phone2').prop('disabled', false);
							        }
							        // Handle error codes
							        if (errorCodes.includes('1')) {
							            $('.otpnotsent_message').show();
							            $('#otpbox, #verifybutton').hide();
							        }
							        if (errorCodes.includes('2')) {
							            $('.otpnotsent_message').show();
							            $('#otpbox, #verifybutton').hide();
							        }
							        if (errorCodes.includes('3')) {
							            $('.invalid_number').show();
							            $('#otpbox, #verifybutton').hide();
							        }
							        if (errorCodes.includes('4')) {
							            $('.already_username').show();
							        }
							        if (errorCodes.includes('5')) {
							            $('.already_email').show();
							        }
							        if (errorCodes.includes('6')) {
							            $('.already_phone').show();
							        }*/

								});

            				});
            			}, 5000);

            		});
            	}

		        var verifyotpBtn = $('#verifybutton');
		        if (verifyotpBtn) {
		        	verifyotpBtn.click(function (event) {
		        		event.preventDefault();
			        	var otp = $('#otpbox').val().trim();
		                // Check if OTP is exactly 4 digits and numeric
		                if (/^\d{4}$/.test(otp)) {
		                    console.log('OTP entered:', otp);
		                    // Proceed with verification logic
		                } else {
		                    console.log('Invalid OTP format.');
		                    // Handle invalid OTP format
		                }
		                $('.otpsent_message,.notverfied-otp-container').hide();
		                $('#loader-container').fadeIn();
		                setTimeout(function() {
		                	$('#loader-container').fadeOut(function() {
		                		usermobile = $('#id_phone2').val();
		            			username = $('#id_username').val();
		            			useremail = $('#id_email').val();
		            			otp = $('#otpbox').val();
				        		event.preventDefault();
				        		var promises = ajax.call([{
		                            methodname: 'moodle_twiliootp_success_twiliootp_url',
		                            args: {flag:1,phone:usermobile,username:username,useremail:useremail,otp:otp},
		                        }]);
		                        promises[0].then(function (options) {
		                        	console.log(options);
		                        	if(options['status'] == true){
		                        		console.log('hoeche');
		                        		$('.verfied-otp-container').show();
						        		$('.send-otp-container').hide();
						        		$('.notverfied-otp-container').hide();
						        		$("#id_submitbutton").prop('disabled', false);
						        		$("#id_phone2,#id_country,#id_username,#id_email").css({'pointer-events':'none', 'background-color': '#e9ecef'});
		                        	} else {
		                        		console.log('hoe ni');
		                        		$('#otpbox').val('');
				        				$('.otpsent_message').hide();
		                        		$('.send-otp-container').show();
				        				$('.notverfied-otp-container').show();
		                        	}
		                        });
		                	});

		                }, 3000);
		        		
		        	});
		        }
		        /*$('#verifybutton').on('click', function(event) {
		        	event.preventDefault();
		        	if($("#otpbox").val()==1234){
		        		console.log('right');
		        		$('.verfied-otp-container').show();
		        		$('.send-otp-container').hide();
		        		$('.notverfied-otp-container').hide();
		        		$("#id_submitbutton").prop('disabled', false);
		        	} else {
		        		console.log('wrong');
		        		$('.send-otp-container').show();
		        		$('.notverfied-otp-container').show();
		        	}
		        	
		        });*/
            }
        };
	});